<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Unified AI Chat üöÄ</title>
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="site.webmanifest">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  transition: background-color 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease, transform 0.2s ease;
}

:root {
  --bg: #020617;
  --panel: #0f172a;
  --chat: #1e293b;
  --border: #1f2937;
  --user: #2563eb;
  --bot: #0f172a;
  --text: #e5e7eb;
  --muted: #94a3b8;
  --link: #22c55e;
  --sidebar: #0a0f1e;
}

body {
  font-family: 'Inter', sans-serif;
  font-size: 16px;
  background: var(--bg);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  color: var(--text);
  overflow: hidden;
}

.container {
  width: 100%;
  max-width: 1200px;
  height: 95vh;
  display: flex;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  border-radius: 16px;
  overflow: hidden;
  background: linear-gradient(135deg, rgba(37,99,235,0.1), rgba(16,185,129,0.08));
}

.sidebar {
  width: 280px;
  background: linear-gradient(180deg, rgba(15,23,42,0.95), rgba(2,6,23,0.98));
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  backdrop-filter: blur(14px);
  transition: transform 0.3s ease;
}

.sidebar-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.search-box {
  width: 100%;
  padding: 10px;
  background: var(--chat);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  outline: none;
  font-size: 14px;
}

.sidebar-controls {
  display: flex;
  gap: 8px;
}

.sidebar-controls button {
  flex: 1;
  background: #2563eb;
  border: none;
  color: #fff;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
}

.sidebar-controls button:hover {
  background: #1d4ed8;
}

.export-btn {
  background: #10b981 !important;
}

.export-btn:hover {
  background: #059669 !important;
}

.history-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.history-group-title {
  font-size: 11px;
  color: var(--muted);
  padding: 8px 12px 4px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.history-item {
  padding: 12px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  border: 1px solid transparent;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
  background: transparent;
}

.history-item:hover {
  background: rgba(255,255,255,0.05);
  border-color: var(--border);
  transform: translateX(4px);
}

.history-item.active {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: #fff;
  box-shadow: 0 10px 30px rgba(37,99,235,0.4);
}

.history-item .title {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.history-item-actions {
  display: flex;
  gap: 6px;
  opacity: 0;
  transition: opacity 0.2s;
}

.history-item:hover .history-item-actions {
  opacity: 1;
}

.pin-chat, .delete-chat {
  background: none;
  border: none;
  color: inherit;
  cursor: pointer;
  font-size: 16px;
  padding: 4px;
}

.history-item.pinned .pin-chat {
  opacity: 1;
  color: #fbbf24;
}

.app {
  flex: 1;
  background: linear-gradient(180deg, rgba(15,23,42,0.85), rgba(2,6,23,0.95));
  display: flex;
  flex-direction: column;
  backdrop-filter: blur(14px);
}

header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  backdrop-filter: blur(12px);
}

#headerTitle {
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
}

.controls {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.controls button {
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
}

.controls button:hover {
  background: rgba(37,99,235,0.2);
  border-color: #2563eb;
  transform: translateY(-2px);
}

.controls select {
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 32px 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  outline: none;
  appearance: none;
  max-width: 200px;
}

.select-wrap {
  position: relative;
}

.select-wrap::after {
  content: "‚ñæ";
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: var(--muted);
}

#chat {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 16px;
  background: radial-gradient(circle at top, rgba(37,99,235,0.08), transparent 50%), var(--chat);
}

.msg {
  max-width: 80%;
  padding: 14px 18px;
  border-radius: 16px;
  line-height: 1.6;
  opacity: 0;
  animation: fadeIn 0.3s forwards;
  position: relative;
  word-wrap: break-word;
  overflow-wrap: anywhere;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4), inset 0 0 0 1px rgba(255,255,255,0.05);
  backdrop-filter: blur(8px);
}

.msg img {
  max-width: 100%;
  border-radius: 12px;
  margin-top: 8px;
}

.user {
  align-self: flex-end;
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: #fff;
  box-shadow: 0 10px 30px rgba(37,99,235,0.5), inset 0 0 0 1px rgba(255,255,255,0.1);
}

.bot {
  align-self: flex-start;
  background: linear-gradient(180deg, rgba(15,23,42,0.95), rgba(2,6,23,0.95));
  color: var(--text);
  box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.05);
}

.msg a {
  color: var(--link);
  text-decoration: underline;
}

.msg-actions {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  gap: 6px;
  opacity: 0;
  transition: opacity 0.2s;
}

.msg:hover .msg-actions {
  opacity: 1;
}

.msg-btn {
  background: rgba(0,0,0,0.7);
  border: none;
  color: #fff;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
}

pre {
  background: #020617;
  border-radius: 12px;
  padding: 16px;
  margin-top: 12px;
  overflow-x: auto;
  max-height: 500px;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08), 0 12px 30px rgba(0,0,0,0.6);
  position: relative;
}

.copy-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #2563eb;
  border: none;
  color: #fff;
  font-size: 11px;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  box-shadow: 0 4px 14px rgba(37,99,235,0.5);
}

footer {
  display: flex;
  gap: 10px;
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  backdrop-filter: blur(12px);
}

.input-container {
  flex: 1;
  display: flex;
  flex-direction: column;
}

input {
  width: 100%;
  padding: 14px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.03);
  color: var(--text);
  outline: none;
  font-size: 15px;
}

.char-counter {
  font-size: 11px;
  color: var(--muted);
  padding: 4px 8px;
  text-align: right;
}

button.send {
  padding: 0 24px;
  border-radius: 10px;
  border: none;
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: #fff;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 10px 30px rgba(37,99,235,0.5);
}

button.send:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 35px rgba(37,99,235,0.6);
}

.voice-btn {
  padding: 0 20px;
  border-radius: 10px;
  border: none;
  background: #10b981;
  color: #fff;
  font-weight: 700;
  cursor: pointer;
  font-size: 18px;
}

.voice-btn:hover {
  background: #059669;
}

.voice-btn.recording {
  background: #ef4444;
  animation: pulse 1.5s infinite;
}

.tts-toggle {
  background: #8b5cf6 !important;
}

.tts-toggle:hover {
  background: #7c3aed !important;
}

.tts-toggle.active {
  background: #10b981 !important;
}

.spinner {
  width: 20px;
  height: 20px;
  border: 3px solid var(--border);
  border-top: 3px solid #2563eb;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@keyframes fadeIn {
  to { opacity: 1; }
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

#chat::-webkit-scrollbar, .history-list::-webkit-scrollbar {
  width: 8px;
}

#chat::-webkit-scrollbar-track, .history-list::-webkit-scrollbar-track {
  background: transparent;
}

#chat::-webkit-scrollbar-thumb, .history-list::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  border-radius: 8px;
}

@media(max-width:768px){
  .container {
    height: 100vh;
    max-width: 100%;
    border-radius: 0;
  }
  
  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    height: 100vh;
    width: 80vw;
    max-width: 300px;
    z-index: 999;
    transform: translateX(-100%);
    box-shadow: 2px 0 12px rgba(0,0,0,0.5);
  }
  
  .sidebar.visible {
    transform: translateX(0);
  }
  
  .msg {
    max-width: 90%;
    font-size: 15px;
  }
  
  header {
    padding: 12px 16px;
  }
  
  #headerTitle {
    font-size: 16px;
  }
  
  .controls {
    gap: 6px;
  }
  
  .controls button {
    padding: 6px 10px;
    font-size: 14px;
  }
  
  .controls select {
    padding: 6px 24px 6px 10px;
    font-size: 12px;
    max-width: 150px;
  }
}
</style>
</head>

<body>
<div class="container">
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <input type="text" class="search-box" id="searchBox" placeholder="üîç Search chats...">
      <div class="sidebar-controls">
        <button onclick="newChat()">+ New</button>
        <button class="export-btn" onclick="exportAll()">üì• Export</button>
      </div>
    </div>
    <div class="history-list" id="historyList"></div>
  </div>

  <div class="app">
    <header>
      <div>
        <span id="headerTitle" ondblclick="editTitle()">Unified AI Chat</span>
      </div>
      <div class="controls">
        <button onclick="clearChat()" title="Clear Chat">üóëÔ∏è</button>
        <button class="tts-toggle" id="ttsToggle" onclick="toggleTTS()" title="Text-to-Speech">üîä</button>
        <div class="select-wrap">
          <select id="imageModel">
            <option value="stabilityai/stable-diffusion-xl-base-1.0">SDXL Base</option>
            <option value="black-forest-labs/FLUX.1-dev">FLUX Dev</option>
            <option value="stabilityai/stable-diffusion-3.5-large">SD 3.5 Large</option>
            <option value="ByteDance/SDXL-Lightning">SDXL Lightning</option>
            <option value="black-forest-labs/FLUX.1-schnell">FLUX Schnell</option>
          </select>
        </div>
        <div class="select-wrap">
          <select id="textModel">
            <option value="deepseek/deepseek-r1-0528:free">DeepSeek R1 (Uncensored)</option>
            <option value="meta-llama/llama-3.3-70b-instruct:free">LLaMA 3.3 70B</option>
            <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash</option>
            <option value="qwen/qwen3-coder:free">Qwen3 Coder</option>
            <option value="mistralai/devstral-2512:free">Mistral Devstral</option>
          </select>
        </div>
      </div>
    </header>

    <div id="chat"></div>

    <footer>
      <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">üé§</button>
      <div class="input-container">
        <input id="input" placeholder="Type or speak your message..." />
        <div class="char-counter" id="charCounter">0 chars</div>
      </div>
      <button class="send" onclick="send()">Send</button>
    </footer>
  </div>
</div>

<script>
// Database
const DB_NAME = 'UnifiedAI_DB';
let db = null;

async function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, 1);
    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };
    request.onupgradeneeded = (e) => {
      const database = e.target.result;
      if (!database.objectStoreNames.contains('chats')) {
        const store = database.createObjectStore('chats', { keyPath: 'id' });
        store.createIndex('timestamp', 'timestamp', { unique: false });
      }
    };
  });
}

async function saveChat(chat) {
  if (!db) await openDB();
  const tx = db.transaction('chats', 'readwrite');
  tx.objectStore('chats').put(chat);
  return new Promise((resolve) => {
    tx.oncomplete = resolve;
  });
}

async function getAllChats() {
  if (!db) await openDB();
  const tx = db.transaction('chats', 'readonly');
  return new Promise((resolve) => {
    const request = tx.objectStore('chats').getAll();
    request.onsuccess = () => resolve(request.result || []);
  });
}

async function deleteChat(id) {
  if (!db) await openDB();
  const tx = db.transaction('chats', 'readwrite');
  tx.objectStore('chats').delete(id);
  return new Promise((resolve) => {
    tx.oncomplete = resolve;
  });
}

// State
let sessions = {};
let currentId = localStorage.getItem('current_chat') || null;
let isGenerating = false;
let recognition = null;
let ttsEnabled = localStorage.getItem('tts_enabled') === 'true';

// Init
async function init() {
  await openDB();
  const chats = await getAllChats();
  sessions = {};
  chats.forEach(c => sessions[c.id] = c);
  
  if (!currentId || !sessions[currentId]) {
    await createNewChat();
  }
  
  renderHistory();
  loadMessages();
  initVoice();
  initEvents();
}

async function createNewChat() {
  currentId = Date.now().toString();
  sessions[currentId] = {
    id: currentId,
    title: "New Chat",
    messages: [],
    timestamp: Date.now(),
    pinned: false
  };
  await saveChat(sessions[currentId]);
  localStorage.setItem('current_chat', currentId);
}

function getCurrentSession() {
  return sessions[currentId];
}

// Voice
function initVoice() {
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.lang = 'en-US';
    
    recognition.onresult = (e) => {
      const text = e.results[0][0].transcript;
      document.getElementById('input').value = text;
      document.getElementById('charCounter').textContent = text.length + ' chars';
      document.getElementById('voiceBtn').classList.remove('recording');
    };
    
    recognition.onend = () => {
      document.getElementById('voiceBtn').classList.remove('recording');
    };
    
    recognition.onerror = () => {
      document.getElementById('voiceBtn').classList.remove('recording');
    };
  }
  
  const btn = document.getElementById('ttsToggle');
  btn.classList.toggle('active', ttsEnabled);
  btn.textContent = ttsEnabled ? 'üîä' : 'üîá';
}

function toggleVoice() {
  if (!recognition) {
    alert('Voice input not supported in your browser');
    return;
  }
  
  const btn = document.getElementById('voiceBtn');
  if (btn.classList.contains('recording')) {
    recognition.stop();
    btn.classList.remove('recording');
  } else {
    btn.classList.add('recording');
    recognition.start();
  }
}

function toggleTTS() {
  ttsEnabled = !ttsEnabled;
  localStorage.setItem('tts_enabled', ttsEnabled);
  const btn = document.getElementById('ttsToggle');
  btn.classList.toggle('active', ttsEnabled);
  btn.textContent = ttsEnabled ? 'üîä' : 'üîá';
}

function speak(text) {
  if (!ttsEnabled || !('speechSynthesis' in window)) return;
  
  window.speechSynthesis.cancel();
  const clean = text.replace(/[*#`]/g, '').replace(/```[\s\S]*?```/g, '[code]').slice(0, 500);
  const utterance = new SpeechSynthesisUtterance(clean);
  utterance.rate = 1.1;
  window.speechSynthesis.speak(utterance);
}

// Render
function renderHistory() {
  const list = document.getElementById('historyList');
  const query = document.getElementById('searchBox').value.toLowerCase();
  
  let filtered = Object.values(sessions);
  if (query) {
    filtered = filtered.filter(s => s.title.toLowerCase().includes(query));
  }
  
  const sorted = filtered.sort((a, b) => b.timestamp - a.timestamp);
  
  list.innerHTML = '';
  
  const pinned = sorted.filter(s => s.pinned);
  const regular = sorted.filter(s => !s.pinned);
  
  if (pinned.length) {
    const title = document.createElement('div');
    title.className = 'history-group-title';
    title.textContent = 'üìå PINNED';
    list.appendChild(title);
    pinned.forEach(renderHistoryItem);
  }
  
  if (regular.length) {
    const title = document.createElement('div');
    title.className = 'history-group-title';
    title.textContent = 'CHATS';
    list.appendChild(title);
    regular.forEach(renderHistoryItem);
  }
}

function renderHistoryItem(session) {
  const div = document.createElement('div');
  div.className = 'history-item' + (session.id === currentId ? ' active' : '') + (session.pinned ? ' pinned' : '');
  
  const title = document.createElement('span');
  title.className = 'title';
  title.textContent = session.title;
  
  const actions = document.createElement('div');
  actions.className = 'history-item-actions';
  
  const pin = document.createElement('button');
  pin.className = 'pin-chat';
  pin.textContent = session.pinned ? '‚≠ê' : '‚òÜ';
  pin.onclick = async (e) => {
    e.stopPropagation();
    session.pinned = !session.pinned;
    await saveChat(session);
    renderHistory();
  };
  
  const del = document.createElement('button');
  del.className = 'delete-chat';
  del.textContent = '‚úï';
  del.onclick = async (e) => {
    e.stopPropagation();
    if (confirm('Delete this chat?')) {
      await deleteChat(session.id);
      delete sessions[session.id];
      if (session.id === currentId) {
        const remaining = Object.keys(sessions);
        if (remaining.length) {
          currentId = remaining[0];
          localStorage.setItem('current_chat', currentId);
          loadMessages();
        } else {
          await createNewChat();
        }
      }
      renderHistory();
    }
  };
  
  actions.appendChild(pin);
  actions.appendChild(del);
  div.appendChild(title);
  div.appendChild(actions);
  
  div.onclick = () => {
    currentId = session.id;
    localStorage.setItem('current_chat', currentId);
    loadMessages();
    renderHistory();
  };
  
  document.getElementById('historyList').appendChild(div);
}

function loadMessages() {
  const chat = document.getElementById('chat');
  chat.innerHTML = '';
  
  const session = getCurrentSession();
  session.messages.forEach(m => renderMessage(m.role, m.content, false));
  
  document.getElementById('headerTitle').textContent = session.title;
  chat.scrollTop = chat.scrollHeight;
}

function renderMessage(role, content, save = true) {
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  
  if (window.marked) {
    div.innerHTML = marked.parse(content);
  } else {
    div.textContent = content;
  }
  
  if (role === 'bot') {
    const actions = document.createElement('div');
    actions.className = 'msg-actions';
    
    const retry = document.createElement('button');
    retry.className = 'msg-btn';
    retry.textContent = 'üîÑ Retry';
    retry.onclick = () => {
      const session = getCurrentSession();
      session.messages.pop();
      loadMessages();
      send();
    };
    
    actions.appendChild(retry);
    div.appendChild(actions);
  }
  
  document.getElementById('chat').appendChild(div);
  
  if (window.hljs) {
    setTimeout(() => {
      div.querySelectorAll('pre code').forEach(block => {
        hljs.highlightElement(block);
        const pre = block.parentElement;
        
        const btn = document.createElement('button');
        btn.className = 'copy-btn';
        btn.textContent = 'COPY';
        btn.onclick = () => {
          navigator.clipboard.writeText(block.textContent);
          btn.textContent = 'COPIED!';
          setTimeout(() => btn.textContent = 'COPY', 1500);
        };
        
        pre.appendChild(btn);
      });
    }, 100);
  }
  
  if (save) {
    const session = getCurrentSession();
    session.messages.push({ role, content });
    session.timestamp = Date.now();
    saveChat(session);
  }
  
  document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
}

async function send() {
  if (isGenerating) return;
  
  const input = document.getElementById('input');
  const prompt = input.value.trim();
  if (!prompt) return;
  
  isGenerating = true;
  input.value = '';
  document.getElementById('charCounter').textContent = '0 chars';
  
  const isImage = prompt.startsWith('/img ');
  let cleanPrompt = isImage ? prompt.slice(5) : prompt;
  
  renderMessage('user', cleanPrompt);
  
  const loading = document.createElement('div');
  loading.className = 'msg bot';
  loading.innerHTML = '<div class="spinner"></div>';
  document.getElementById('chat').appendChild(loading);
  
  try {
    if (isImage) {
      const model = document.getElementById('imageModel').value;
      const res = await fetch('https://hackoai-worker.tariqmtaezeem.workers.dev/hf/img', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: cleanPrompt, model })
      });
      
      const { url } = await res.json();
      loading.remove();
      
      const div = document.createElement('div');
      div.className = 'msg bot';
      const img = document.createElement('img');
      img.src = url;
      img.style.maxWidth = '100%';
      img.style.borderRadius = '12px';
      div.appendChild(img);
      document.getElementById('chat').appendChild(div);
      
      const session = getCurrentSession();
      session.messages.push({ role: 'bot', content: `![Generated Image](${url})` });
      await saveChat(session);
    } else {
      const model = document.getElementById('textModel').value;
      const session = getCurrentSession();
      const messages = session.messages
        .filter(m => !m.content.includes('![Generated'))
        .map(m => ({ role: m.role === 'bot' ? 'assistant' : 'user', content: m.content }));
      
      messages.push({ role: 'user', content: cleanPrompt });
      
      const res = await fetch('https://hackoai-worker.tariqmtaezeem.workers.dev/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model, messages })
      });
      
      const data = await res.json();
      const answer = data.choices[0].message.content;
      
      loading.remove();
      renderMessage('bot', answer);
      speak(answer);
      
      // Auto-title
      if (session.messages.filter(m => m.role === 'user').length === 1) {
        const titleRes = await fetch('https://hackoai-worker.tariqmtaezeem.workers.dev/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'deepseek/deepseek-r1-0528:free',
            messages: [
              { role: 'system', content: 'Create a 2-4 word chat title. No quotes.' },
              { role: 'user', content: `User: ${cleanPrompt}\nBot: ${answer}` }
            ]
          })
        });
        
        const titleData = await titleRes.json();
        const newTitle = titleData.choices[0].message.content.replace(/["'\n]/g, '').trim().slice(0, 40);
        session.title = newTitle || 'New Chat';
        await saveChat(session);
        document.getElementById('headerTitle').textContent = session.title;
        renderHistory();
      }
    }
  } catch (err) {
    console.error(err);
    loading.remove();
    renderMessage('bot', '**Error:** ' + err.message);
  }
  
  isGenerating = false;
}

async function newChat() {
  await createNewChat();
  document.getElementById('chat').innerHTML = '';
  renderHistory();
  document.getElementById('headerTitle').textContent = 'New Chat';
}

async function clearChat() {
  if (!confirm('Clear this chat?')) return;
  const session = getCurrentSession();
  session.messages = [];
  session.title = 'New Chat';
  await saveChat(session);
  loadMessages();
}

function editTitle() {
  const session = getCurrentSession();
  const header = document.getElementById('headerTitle');
  const oldTitle = session.title;
  
  const input = document.createElement('input');
  input.value = oldTitle;
  input.style.cssText = `
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 700;
  `;
  
  header.replaceWith(input);
  input.focus();
  input.select();
  
  const save = async () => {
    const newTitle = input.value.trim() || oldTitle;
    session.title = newTitle;
    await saveChat(session);
    
    const span = document.createElement('span');
    span.id = 'headerTitle';
    span.textContent = newTitle;
    span.ondblclick = editTitle;
    input.replaceWith(span);
    renderHistory();
  };
  
  input.onblur = save;
  input.onkeydown = (e) => {
    if (e.key === 'Enter') save();
    if (e.key === 'Escape') {
      input.value = oldTitle;
      save();
    }
  };
}

async function exportAll() {
  const data = JSON.stringify(sessions, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `unified-ai-backup-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function initEvents() {
  const input = document.getElementById('input');
  const searchBox = document.getElementById('searchBox');
  
  input.addEventListener('input', () => {
    const len = input.value.length;
    const counter = document.getElementById('charCounter');
    counter.textContent = `${len} chars`;
    counter.style.color = len > 4000 ? '#ef4444' : len > 2000 ? '#f59e0b' : 'var(--muted)';
  });
  
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });
  
  searchBox.addEventListener('input', renderHistory);
  
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'b') {
      e.preventDefault();
      newChat();
    }
  });
}

// Math rendering
if (window.renderMathInElement) {
  const observer = new MutationObserver(() => {
    document.querySelectorAll('.msg.bot').forEach(el => {
      renderMathInElement(el, {
        delimiters: [
          { left: "$", right: "$", display: true },
          { left: "\\(", right: "\\)", display: false }
        ]
      });
    });
  });
  
  document.addEventListener('DOMContentLoaded', () => {
    observer.observe(document.getElementById('chat'), { childList: true, subtree: true });
  });
}

// Mobile sidebar toggle
window.toggleSidebar = function() {
  document.getElementById('sidebar').classList.toggle('visible');
};

// Add mobile menu button on small screens
if (window.innerWidth <= 768) {
  const menuBtn = document.createElement('button');
  menuBtn.textContent = '‚ò∞';
  menuBtn.style.cssText = `
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 18px;
    margin-right: 10px;
  `;
  menuBtn.onclick = toggleSidebar;
  
  document.addEventListener('DOMContentLoaded', () => {
    const header = document.querySelector('header > div:first-child');
    if (header) {
      header.insertBefore(menuBtn, header.firstChild);
    }
  });
}

// Start app
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
